<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREVO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #00B894; --light: #00D4AA; --dark: #009975;
            --bg: #0A0A0A; --card: #1A1A1A; --text: #FFFFFF; --secondary: #A0A0A0;
            --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
        }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .app { height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        .header { background: var(--card); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 8px; font-size: 20px; font-weight: 700; color: var(--primary); }
        .balance-section { display: flex; align-items: center; gap: 12px; }
        .balance-card, .energy-section { background: var(--bg); padding: 8px 12px; border-radius: 12px; display: flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 600; }
        
        /* Navigation */
        .tabs { display: flex; background: var(--card); margin: 0 12px; border-radius: 12px; overflow: hidden; }
        .tab-btn { flex: 1; padding: 14px; background: none; border: none; color: var(--secondary); font-size: 14px; font-weight: 500; cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        /* Content */
        .content { flex: 1; overflow-y: auto; padding: 0 12px 20px; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; }
        
        /* Clicker Section */
        .clicker-section { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .daily-bonus { position: absolute; top: 20px; right: 16px; background: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .clicker-circle { width: 220px; height: 220px; border-radius: 50%; background: var(--card); display: flex; align-items: center; justify-content: center; margin: 40px 0; position: relative; }
        .clicker-btn { width: 180px; height: 180px; border-radius: 50%; background: var(--primary); border: none; cursor: pointer; transition: all 0.1s ease; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 700; color: white; }
        .clicker-btn:active { transform: scale(0.95); }
        .stats-section { background: var(--card); border-radius: 16px; padding: 16px; width: 100%; max-width: 320px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
        .progress-bar { width: 100%; height: 6px; background: #2A2A2A; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s ease; }
        
        /* Tasks Section */
        .tasks-section { background: var(--card); border-radius: 16px; padding: 20px; margin-top: 20px; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .tasks-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .task-card { background: var(--bg); border-radius: 12px; padding: 16px; text-align: center; }
        .task-title { font-size: 12px; color: var(--secondary); margin-bottom: 4px; }
        .task-reward { font-size: 14px; font-weight: 700; color: var(--primary); }
        .task-btn { width: 100%; padding: 8px; background: var(--primary); border: none; border-radius: 8px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .task-btn.completed { background: var(--secondary); cursor: not-allowed; }
        
        /* Leaders Section */
        .leaders-section { padding: 20px 0; }
        .leaderboard { background: var(--card); border-radius: 16px; padding: 20px; }
        .leader-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #2A2A2A; }
        .leader-item:last-child { border-bottom: none; }
        .leader-rank { width: 24px; font-weight: 600; margin-right: 12px; text-align: center; }
        .rank-1 { color: var(--gold); }
        .rank-2 { color: var(--silver); }
        .rank-3 { color: var(--bronze); }
        .leader-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 12px; font-size: 14px; }
        .leader-info { flex: 1; }
        .leader-name { font-size: 14px; font-weight: 500; }
        .leader-score { font-size: 14px; font-weight: 600; color: var(--primary); }
        .current-user { background: rgba(0, 184, 148, 0.1); border-radius: 8px; margin: 0 -8px; padding: 0 8px; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; color: var(--secondary); }
        .loading-spinner { width: 20px; height: 20px; border: 2px solid var(--secondary); border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Animations */
        @keyframes coinPop { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.1); opacity: 0; } }
        .coin-pop { animation: coinPop 0.8s ease-out forwards; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .pulse { animation: pulse 2s infinite; }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="logo">DREVO</div>
            <div class="balance-section">
                <div class="energy-section"><span id="energy">1000/1000</span></div>
                <div class="balance-card"><span id="balance">0</span></div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="tabs">
            <button class="tab-btn active" onclick="switchTab('clicker')">Clicker</button>
            <button class="tab-btn" onclick="switchTab('tasks')">Tasks</button>
            <button class="tab-btn" onclick="switchTab('leaders')">Leaders</button>
        </nav>
        
        <main class="content">
            <!-- Clicker Tab -->
            <div id="clicker-tab" class="tab-content active">
                <div class="clicker-section">
                    <div class="daily-bonus">Daily limit</div>
                    <div class="clicker-circle">
                        <button class="clicker-btn pulse" id="click-btn">D</button>
                    </div>
                    <div class="stats-section">
                        <div class="stat-row"><span>Points per tap</span><span>+1</span></div>
                        <div class="stat-row"><span>Daily limit</span><span id="today-limit">0/1000</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>
            
            <!-- Tasks Tab -->
            <div id="tasks-tab" class="tab-content">
                <div class="tasks-section">
                    <div class="section-title">Tasks</div>
                    <div class="tasks-grid">
                        <div class="task-card" id="task-channel1">
                            <div class="task-title">Join DREVO Coin</div>
                            <div class="task-reward">+1000 D</div>
                            <button class="task-btn" onclick="completeTask('channel1')">Join</button>
                        </div>
                        <div class="task-card" id="task-channel2">
                            <div class="task-title">Join OneSK</div>
                            <div class="task-reward">+1000 D</div>
                            <button class="task-btn" onclick="completeTask('channel2')">Join</button>
                        </div>
                        <div class="task-card" id="task-chat">
                            <div class="task-title">Join DREVO Community</div>
                            <div class="task-reward">+1000 D</div>
                            <button class="task-btn" onclick="completeTask('chat')">Join</button>
                        </div>
                        <div class="task-card" id="task-invite">
                            <div class="task-title">Invite Friends</div>
                            <div class="task-reward">+500 D</div>
                            <button class="task-btn" onclick="completeTask('invite')">Invite</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Leaders Tab -->
            <div id="leaders-tab" class="tab-content">
                <div class="leaders-section">
                    <div class="leaderboard">
                        <div class="section-title">Top Players</div>
                        <div id="leaders-list">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <div>Loading leaderboard...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        
        // Online leaderboard storage simulation (using localStorage as "server")
        const LEADERBOARD_KEY = 'drevo_global_leaderboard';
        
        // Initialize state
        let state = { 
            balance: 0, 
            energy: 1000, 
            clicksToday: 0, 
            completedTasks: {
                channel1: false,
                channel2: false, 
                chat: false, 
                invite: false
            },
            userId: null,
            username: 'User',
            lastClickDate: null
        };

        function init() {
            tg.expand();
            setupUser();
            loadState();
            setupEventListeners();
            updateUI();
            updateLeadersBoard();
        }
        
        function setupUser() {
            const user = tg.initDataUnsafe.user;
            state.userId = user?.id || Math.floor(Math.random() * 1000000000);
            state.username = user?.first_name || 'User' + state.userId.toString().slice(-4);
            
            // Initialize user in global leaderboard
            initializeUserInLeaderboard();
        }
        
        function initializeUserInLeaderboard() {
            const globalLeaderboard = getGlobalLeaderboard();
            const existingUser = globalLeaderboard.find(u => u.id === state.userId);
            
            if (!existingUser) {
                globalLeaderboard.push({
                    id: state.userId,
                    name: state.username,
                    score: 0,
                    lastActive: Date.now()
                });
                saveGlobalLeaderboard(globalLeaderboard);
            } else {
                // Update username if changed
                existingUser.name = state.username;
                existingUser.lastActive = Date.now();
                saveGlobalLeaderboard(globalLeaderboard);
            }
        }
        
        function getGlobalLeaderboard() {
            try {
                return JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || [];
            } catch {
                return [];
            }
        }
        
        function saveGlobalLeaderboard(leaderboard) {
            // Clean up inactive users (older than 30 days)
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const activeLeaderboard = leaderboard.filter(user => user.lastActive > thirtyDaysAgo);
            
            // Sort by score
            activeLeaderboard.sort((a, b) => b.score - a.score);
            
            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(activeLeaderboard));
            return activeLeaderboard;
        }
        
        function updateUserScore() {
            const globalLeaderboard = getGlobalLeaderboard();
            const userIndex = globalLeaderboard.findIndex(u => u.id === state.userId);
            
            if (userIndex !== -1) {
                globalLeaderboard[userIndex].score = state.balance;
                globalLeaderboard[userIndex].lastActive = Date.now();
                globalLeaderboard[userIndex].name = state.username;
                saveGlobalLeaderboard(globalLeaderboard);
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'tasks') updateTasksUI();
            if (tabName === 'leaders') updateLeadersBoard();
        }
        
        function loadState() {
            const userKey = `drevoState_${state.userId}`;
            const saved = localStorage.getItem(userKey);
            
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    const today = new Date().toDateString();
                    
                    if (parsed.lastClickDate !== today) { 
                        state.clicksToday = 0; 
                        state.energy = 1000; 
                    } else { 
                        state.clicksToday = parsed.clicksToday || 0; 
                        state.energy = 1000 - state.clicksToday; 
                    }
                    
                    state.balance = parsed.balance || 0;
                    state.completedTasks = parsed.completedTasks || {
                        channel1: false,
                        channel2: false, 
                        chat: false, 
                        invite: false
                    };
                    state.lastClickDate = today;
                    
                } catch (e) {
                    console.error('Error loading state:', e);
                    resetState();
                }
            } else {
                resetState();
            }
            
            saveState();
        }
        
        function resetState() {
            state.balance = 0;
            state.energy = 1000;
            state.clicksToday = 0;
            state.completedTasks = {
                channel1: false,
                channel2: false, 
                chat: false, 
                invite: false
            };
            state.lastClickDate = new Date().toDateString();
        }
        
        function saveState() { 
            const userKey = `drevoState_${state.userId}`;
            state.lastClickDate = new Date().toDateString(); 
            localStorage.setItem(userKey, JSON.stringify(state));
            updateUserScore();
        }
        
        function setupEventListeners() { 
            document.getElementById('click-btn').addEventListener('click', handleClick); 
        }
        
        function handleClick() {
            if (state.energy <= 0) { 
                tg.showAlert('Daily limit reached!'); 
                return; 
            }
            state.balance++; 
            state.energy--; 
            state.clicksToday++;
            showCoinAnimation(); 
            tg.HapticFeedback.impactOccurred('light'); 
            saveState(); 
            updateUI();
            updateLeadersBoard();
        }
        
        function showCoinAnimation() {
            const coin = document.createElement('div'); 
            coin.className = 'coin-pop'; 
            coin.textContent = '+1'; 
            coin.style.cssText = 'position:absolute;font-size:16px;font-weight:700;color:#00B894;opacity:0;';
            document.getElementById('click-btn').parentElement.appendChild(coin); 
            setTimeout(() => coin.remove(), 800);
        }
        
        function completeTask(taskId) {
            if (state.completedTasks[taskId]) { 
                tg.showAlert('Task already completed!'); 
                return; 
            }
            
            const urls = { 
                channel1: 'https://t.me/drevocoin', 
                channel2: 'https://t.me/onesk', 
                chat: 'https://t.me/drevocommunity', 
                invite: 'https://t.me/share/url?url=https://t.me/drevo_bot' 
            };
            
            if (urls[taskId]) {
                tg.openLink(urls[taskId]);
            }
            
            setTimeout(() => {
                const reward = taskId === 'invite' ? 500 : 1000;
                state.balance += reward; 
                state.completedTasks[taskId] = true; 
                tg.HapticFeedback.impactOccurred('success');
                
                tg.showPopup({ 
                    title: 'Task Completed!', 
                    message: `You received ${reward} DREVO points!`, 
                    buttons: [{ type: 'ok' }] 
                });
                
                saveState(); 
                updateUI(); 
                updateTasksUI();
                updateLeadersBoard();
            }, 2000);
        }
        
        function updateUI() {
            document.getElementById('balance').textContent = state.balance.toLocaleString();
            document.getElementById('energy').textContent = state.energy + '/1000';
            document.getElementById('today-limit').textContent = state.clicksToday + '/1000';
            document.getElementById('progress-fill').style.width = (state.clicksToday / 1000) * 100 + '%';
            
            const clickBtn = document.getElementById('click-btn');
            if (state.energy <= 0) { 
                clickBtn.classList.remove('pulse'); 
                clickBtn.style.opacity = '0.6'; 
            } else { 
                clickBtn.classList.add('pulse'); 
                clickBtn.style.opacity = '1'; 
            }
        }
        
        function updateTasksUI() {
            Object.keys(state.completedTasks).forEach(taskId => {
                const taskCard = document.getElementById('task-' + taskId); 
                const btn = taskCard.querySelector('.task-btn');
                
                if (state.completedTasks[taskId]) {
                    btn.textContent = 'Completed'; 
                    btn.disabled = true; 
                    btn.classList.add('completed');
                } else {
                    btn.textContent = taskId === 'invite' ? 'Invite' : 'Join';
                    btn.disabled = false;
                    btn.classList.remove('completed');
                }
            });
        }
        
        function updateLeadersBoard() {
            const globalLeaderboard = getGlobalLeaderboard();
            const topPlayers = globalLeaderboard.slice(0, 10); // Get top 10
            
            const leadersList = document.getElementById('leaders-list');
            
            if (topPlayers.length === 0) {
                leadersList.innerHTML = '<div class="loading">No players yet</div>';
                return;
            }
            
            leadersList.innerHTML = topPlayers.map((player, index) => {
                const isCurrentUser = player.id === state.userId;
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                
                return `
                    <div class="leader-item ${isCurrentUser ? 'current-user' : ''}">
                        <div class="leader-rank ${rankClass}">${index + 1}</div>
                        <div class="leader-avatar">${player.name.charAt(0).toUpperCase()}</div>
                        <div class="leader-info">
                            <div class="leader-name">${player.name} ${isCurrentUser ? '(You)' : ''}</div>
                        </div>
                        <div class="leader-score">${player.score.toLocaleString()} D</div>
                    </div>
                `;
            }).join('');
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>